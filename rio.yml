schemaVersion: 2.0

notify:
  email:
    enabled: false

machine:
  java:
    version: 8-applejdk

builds:
  - name: publish-parquet-mr-1.12.x-apple-snapshot
    branchName: parquet-1.12.x-dev-apple
    machine:
      baseImage: docker.apple.com/cpbuild7/applejdk-8
      env:
        LOCAL_REPO: ".dist/local-repo"
        MAVEN_PARMS: "-Drat.skip=true -DskipTests=true"
    build:
      template: freestyle:v4:publish
      steps:
        - mkdir -p "$LOCAL_REPO"
        - yum install -q -y autoconf automake libtool unzip gcc-c++ zlib-devel openssl-devel file
        - mkdir temp && cd temp
        - wget https://github.com/google/protobuf/archive/v3.5.1.tar.gz -O protobuf-3.5.1.tar.gz && tar xzf protobuf-3.5.1.tar.gz
        - cd protobuf-3.5.1 && ./autogen.sh > /dev/null 2>&1 && ./configure > /dev/null 2>&1
        - make -j8 > /dev/null 2>&1 && make install > /dev/null 2>&1  && ldconfig > /dev/null 2>&1
        - cd ..
        - wget -nv http://archive.apache.org/dist/thrift/0.13.0/thrift-0.15.0.tar.gz && tar xzf thrift-0.15.0.tar.gz
        - cd thrift-0.15.0 && chmod +x ./configure
        - ./configure --disable-libs > /dev/null 2>&1
        - make -j8 > /dev/null 2>&1 && make install > /dev/null 2>&1
        - cd ..
        - wget https://jitpack.io/com/github/rdblue/brotli-codec/0.1.1/brotli-codec-0.1.1.jar
        - mvn $MAVEN_PARM org.apache.maven.plugins:maven-install-plugin:2.5.2:install-file -Dfile=brotli-codec-0.1.1.jar -DgroupId=com.github.rdblue -DartifactId=brotli-codec -Dversion=0.1.1 -Dpackaging=jar > /dev/null 2>&1
        - cd .. && rm -rf temp
        - mvn $MAVEN_PARMS com.apple.cie.rio:rio-maven-plugin:create-marker -DskipTests=true
        - mvn $MAVEN_PARMS clean deploy -DaltDeploymentRepository="local-release::default::file://$PWD/$LOCAL_REPO"
        - ci stage-lib --many-many-artifacts "$LOCAL_REPO/**/*" --exclude "**/*.xml" --exclude "**/*.md5" --exclude "**/*.sha1"
    package:
      freeform:
        - publish:
            - repo: m2:oss-patched

  - name: run-test-parquet-mr-1.12.x-apple-snapshot
    branchName: parquet-1.12.x-dev-apple
    machine:
      baseImage: docker.apple.com/cpbuild7/applejdk-8
      env:
        MAVEN_PARMS: "-Drat.skip=true"
    build:
      template: freestyle:v4:build
      steps: &test_steps
        - yum install -y autoconf automake libtool unzip gcc-c++ zlib-devel openssl-devel file
        - mkdir temp && cd temp
        - wget https://github.com/google/protobuf/archive/v3.5.1.tar.gz -O protobuf-3.5.1.tar.gz && tar xzf protobuf-3.5.1.tar.gz
        - cd protobuf-3.5.1 && ./autogen.sh && ./configure
        - make -j8 && make install && ldconfig
        - cd ..
        - wget -nv http://archive.apache.org/dist/thrift/0.15.0/thrift-0.15.0.tar.gz && tar xzf thrift-0.15.0.tar.gz
        - cd thrift-0.15.0 && chmod +x ./configure
        - ./configure --disable-libs
        - make -j8 && make install
        - cd ..
        - wget https://jitpack.io/com/github/rdblue/brotli-codec/0.1.1/brotli-codec-0.1.1.jar
        - mvn $MAVEN_PARM org.apache.maven.plugins:maven-install-plugin:2.5.2:install-file -Dfile=brotli-codec-0.1.1.jar -DgroupId=com.github.rdblue -DartifactId=brotli-codec -Dversion=0.1.1 -Dpackaging=jar
        - cd .. && rm -rf temp
        - mvn $MAVEN_PARMS clean test
    package:
      freeform:
        - publish:
            - repo: m2:oss-patched

  - name: parquet-mr-1.12.x-apple-snapshot-pr
    branchName: parquet-1.12.x-dev-apple
    machine:
      baseImage: docker.apple.com/cpbuild7/applejdk-8
      env:
        MAVEN_PARMS: "-Drat.skip=true"
    build:
      template: freestyle:v4:prb
      steps:
        <<: *test_steps

  - name: publish-parquet-mr-1.12.x-apple-release
    branchName: parquet-1.12.x-dev-apple-release
    machine:
      baseImage: docker.apple.com/cpbuild7/applejdk-8
      env:
        LOCAL_REPO: ".dist/local-repo"
        MAVEN_PARMS: "-Drat.skip=true -DskipTests=true"
    build:
      template: freestyle:v4:publish
      steps:
        - mkdir -p "$LOCAL_REPO"
        - yum install -q -y autoconf automake libtool unzip gcc-c++ zlib-devel openssl-devel file
        - mkdir temp && cd temp
        - wget https://github.com/google/protobuf/archive/v3.5.1.tar.gz -O protobuf-3.5.1.tar.gz && tar xzf protobuf-3.5.1.tar.gz
        - cd protobuf-3.5.1 && ./autogen.sh > /dev/null 2>&1 && ./configure > /dev/null 2>&1
        - make -j8 > /dev/null 2>&1 && make install > /dev/null 2>&1  && ldconfig > /dev/null 2>&1
        - cd ..
        - wget -nv http://archive.apache.org/dist/thrift/0.15.0/thrift-0.15.0.tar.gz && tar xzf thrift-0.15.0.tar.gz
        - cd thrift-0.15.0 && chmod +x ./configure
        - ./configure --disable-libs > /dev/null 2>&1
        - make -j8 > /dev/null 2>&1 && make install > /dev/null 2>&1
        - cd ..
        - wget https://jitpack.io/com/github/rdblue/brotli-codec/0.1.1/brotli-codec-0.1.1.jar
        - mvn $MAVEN_PARM org.apache.maven.plugins:maven-install-plugin:2.5.2:install-file -Dfile=brotli-codec-0.1.1.jar -DgroupId=com.github.rdblue -DartifactId=brotli-codec -Dversion=0.1.1 -Dpackaging=jar > /dev/null 2>&1
        - cd .. && rm -rf temp
        - mvn $MAVEN_PARMS com.apple.cie.rio:rio-maven-plugin:create-marker -DskipTests=true
        - mvn $MAVEN_PARMS com.apple.cie.rio:rio-maven-plugin:remove-snapshot org.codehaus.mojo:versions-maven-plugin:set
        - mvn $MAVEN_PARMS clean deploy -DaltDeploymentRepository="local-release::default::file://$PWD/$LOCAL_REPO"
        - ci stage-lib --many-many-artifacts "$LOCAL_REPO/**/*" --exclude "**/*.xml" --exclude "**/*.md5" --exclude "**/*.sha1"
    package:
      release: true
      freeform:
        - publish:
            - repo: m2:oss-patched
    finally:
      tag:
        enabled: true
        expression: "1.12.0.0-dev-apple"
